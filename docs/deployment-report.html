<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Production Deployment - Lessons Learned</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            font-size: 11pt;
            max-width: 210mm;
            margin: 0 auto;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28pt;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header h2 {
            margin: 10px 0;
            font-size: 18pt;
            font-weight: normal;
            opacity: 0.9;
        }
        
        .header .meta {
            font-size: 12pt;
            margin-top: 15px;
            opacity: 0.8;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            page-break-after: avoid;
            font-size: 22pt;
            margin-top: 30px;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
            page-break-after: avoid;
            font-size: 18pt;
            margin-top: 25px;
        }
        
        h3 {
            color: #2c3e50;
            page-break-after: avoid;
            font-size: 14pt;
            margin-top: 20px;
            font-weight: bold;
        }
        
        h4 {
            color: #7f8c8d;
            font-size: 12pt;
            margin-top: 15px;
            font-weight: bold;
        }
        
        .error-section {
            border: 2px solid #e74c3c;
            background: linear-gradient(to right, #fdf2f2, #ffffff);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            page-break-inside: avoid;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .solution-section {
            border: 2px solid #27ae60;
            background: linear-gradient(to right, #f2fdf2, #ffffff);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            page-break-inside: avoid;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            page-break-inside: avoid;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 9pt;
            line-height: 1.4;
            margin: 15px 0;
            position: relative;
        }
        
        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 8pt;
            color: #666;
            text-transform: uppercase;
        }
        
        .inline-code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            padding: 2px 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 10pt;
            color: #e74c3c;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            page-break-inside: avoid;
            font-size: 10pt;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .metrics-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .success { color: #27ae60; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .architecture-diagram {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            text-align: center;
            page-break-inside: avoid;
        }
        
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            font-size: 9pt;
            color: #666;
            text-align: center;
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
        
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 5px 0;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        @media print {
            body { font-size: 10pt; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ ETL System Production Deployment</h1>
        <h2>Lessons Learned & Solutions Documentation</h2>
        <div class="meta">
            <strong>BRQ Ita√∫ - ETL Team</strong><br>
            Spring Boot 3.2.2 + Kotlin + AWS EKS + MSK<br>
            Generated: October 14, 2025
        </div>
    </div>

    <div class="highlight-box">
        <h2 style="margin: 0; border: none;">üìã Executive Summary</h2>
        <p style="font-size: 12pt; margin: 10px 0;">
            Sistema 100% operacional ap√≥s migra√ß√£o cr√≠tica de <strong>Fargate ‚Üí EC2</strong><br>
            <span class="success">‚úÖ DNS Functional</span> ‚Ä¢ 
            <span class="success">‚úÖ MSK Connected</span> ‚Ä¢ 
            <span class="success">‚úÖ Health Checks UP</span>
        </p>
    </div>

    <h1>üö® Principais Erros e Solu√ß√µes</h1>

    <div class="error-section">
        <h2><span class="emoji">‚ùå</span>Erro 1: Dependency Injection - ObjectMapper</h2>
        <h3>Problema:</h3>
        <div class="code-block" data-lang="kotlin">
Parameter 0 of constructor in br.com.brq.producer.service.S3Service required a bean of type 
'com.fasterxml.jackson.databind.ObjectMapper' that could not be found.
        </div>
        
        <h3>Causa Raiz:</h3>
        <ul>
            <li>Spring Boot n√£o estava auto-configurando o ObjectMapper</li>
            <li>Falta de dependency expl√≠cita no build.gradle</li>
        </ul>
    </div>

    <div class="solution-section">
        <h3><span class="emoji">‚úÖ</span>Solu√ß√£o Adotada:</h3>
        <div class="code-block" data-lang="kotlin">
@Configuration
class JacksonConfig {
    @Bean
    @Primary
    fun objectMapper(): ObjectMapper {
        return ObjectMapper()
            .registerModule(JavaTimeModule())
            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)
            .configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false)
    }
}
        </div>
        
        <h3>Base da Decis√£o:</h3>
        <ul>
            <li><strong>Padr√£o Spring Boot:</strong> Configura√ß√£o expl√≠cita de beans cr√≠ticos</li>
            <li><strong>Robustez:</strong> Controle total sobre serializa√ß√£o JSON</li>
            <li><strong>Manutenibilidade:</strong> Configura√ß√£o centralizada</li>
        </ul>
    </div>

    <div class="page-break"></div>

    <div class="error-section">
        <h2><span class="emoji">‚ùå</span>Erro 2: ECR Authentication - Credenciais AWS</h2>
        <h3>Problema:</h3>
        <div class="code-block" data-lang="bash">
Error response from daemon: pull access denied for 
521176574385.dkr.ecr.sa-east-1.amazonaws.com/dry-run-brq-producer
        </div>
        
        <h3>Causa Raiz:</h3>
        <ul>
            <li>Token ECR expirado</li>
            <li>Falta de login no registry</li>
        </ul>
    </div>

    <div class="solution-section">
        <h3><span class="emoji">‚úÖ</span>Solu√ß√£o Adotada:</h3>
        <div class="code-block" data-lang="bash">
# Script de deploy automatizado
aws ecr get-login-password --region sa-east-1 | \
docker login --username AWS --password-stdin \
521176574385.dkr.ecr.sa-east-1.amazonaws.com

docker build -t dry-run-brq-producer .
docker tag dry-run-brq-producer:latest \
521176574385.dkr.ecr.sa-east-1.amazonaws.com/dry-run-brq-producer:latest
docker push 521176574385.dkr.ecr.sa-east-1.amazonaws.com/dry-run-brq-producer:latest
        </div>
    </div>

    <div class="error-section">
        <h2><span class="emoji">üî•</span>Erro CR√çTICO: DNS Resolution Failure - Fargate</h2>
        <h3>Problema:</h3>
        <div class="code-block" data-lang="bash">
# Pods no Fargate
kubectl exec producer -- nslookup b-1.dryrunbrqmsk.cxgo3g.c2.kafka.sa-east-1.amazonaws.com
# RESULTADO: Name resolution failure
        </div>
        
        <h3>Causa Raiz:</h3>
        <ul>
            <li><span class="error">Fargate DNS Limitations:</span> Problemas conhecidos com DNS customizado</li>
            <li><span class="error">MSK Private Endpoints:</span> Resolu√ß√£o interna VPC n√£o funcionando</li>
            <li><span class="error">AWS API Calls:</span> WebIdentityTokenCredentialsProvider falhando</li>
        </ul>

        <h3>Solu√ß√µes Tentadas (SEM SUCESSO):</h3>
        <ul>
            <li>‚úÖ VPC Endpoints: S3, DynamoDB, STS, EC2, CloudWatch</li>
            <li>‚úÖ DNS Configuration: CoreDNS troubleshooting</li>
            <li>‚úÖ Network Policies: Security groups validation</li>
            <li><span class="error">‚ùå Fargate Profile:</span> Configura√ß√µes personalizadas</li>
        </ul>
    </div>

    <div class="solution-section">
        <h2><span class="emoji">üéØ</span>SOLU√á√ÉO FINAL: Migra√ß√£o Fargate ‚Üí EC2</h2>
        
        <div class="code-block" data-lang="terraform">
# Terraform - Migra√ß√£o para EC2 Managed Nodes
eks_managed_node_groups = {
  workers = {
    name         = "workers"
    min_size     = 1
    max_size     = 3
    desired_size = 2
    instance_types = ["t3.small"]  # Upgrade de t3.micro
    
    labels = {
      Environment = "production"
      NodeType    = "worker"
    }
  }
}
        </div>

        <h3>Base da Decis√£o:</h3>
        <ul>
            <li><strong>Networking Reliability:</strong> EC2 nodes n√£o t√™m limita√ß√µes DNS do Fargate</li>
            <li><strong>Troubleshooting:</strong> Maior controle sobre network stack</li>
            <li><strong>Production Stability:</strong> Evitar limita√ß√µes conhecidas do Fargate</li>
            <li><strong>Cost-Benefit:</strong> t3.small adequado (11 pods vs 4 pods t3.micro)</li>
        </ul>
    </div>

    <h1>üìä Arquitetura: Antes vs Depois</h1>

    <div class="architecture-diagram">
        <h3 style="color: #e74c3c;">‚ùå ANTES (Problem√°tica)</h3>
        <pre>
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   S3 Bucket     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Fargate Pods    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   MSK Cluster   ‚îÇ
‚îÇ   (Input)       ‚îÇ    ‚îÇ  (DNS Issues)    ‚îÇ    ‚îÇ  (Unreachable)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                       ‚ùå DNS Failures
                       ‚ùå AWS API Errors
                       ‚ùå Connection Timeouts
        </pre>
    </div>

    <div class="architecture-diagram">
        <h3 style="color: #27ae60;">‚úÖ DEPOIS (Operacional)</h3>
        <pre>
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   S3 Bucket     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   EC2 Nodes      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   MSK Cluster   ‚îÇ
‚îÇ   (Input)       ‚îÇ    ‚îÇ  (t3.small)      ‚îÇ    ‚îÇ   (Connected)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                       ‚úÖ DNS Functional
                       ‚úÖ AWS APIs Working
                       ‚úÖ Health Checks UP
        </pre>
    </div>

    <h1>üìà M√©tricas de Sucesso</h1>

    <table class="metrics-table">
        <thead>
            <tr>
                <th>M√©trica</th>
                <th>Fargate (Falha)</th>
                <th>EC2 (Sucesso)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>DNS Resolution</strong></td>
                <td><span class="error">‚ùå 0%</span></td>
                <td><span class="success">‚úÖ 100%</span></td>
            </tr>
            <tr>
                <td><strong>Health Checks</strong></td>
                <td><span class="error">‚ùå Timeout</span></td>
                <td><span class="success">‚úÖ 200ms avg</span></td>
            </tr>
            <tr>
                <td><strong>MSK Connectivity</strong></td>
                <td><span class="error">‚ùå Failed</span></td>
                <td><span class="success">‚úÖ Connected</span></td>
            </tr>
            <tr>
                <td><strong>AWS API Calls</strong></td>
                <td><span class="error">‚ùå Credentials Error</span></td>
                <td><span class="success">‚úÖ Working</span></td>
            </tr>
            <tr>
                <td><strong>Pod Scheduling</strong></td>
                <td><span class="error">‚ùå Resource Limits</span></td>
                <td><span class="success">‚úÖ Optimal</span></td>
            </tr>
            <tr>
                <td><strong>Deployment Time</strong></td>
                <td><span class="error">‚ùå 2+ hours debug</span></td>
                <td><span class="success">‚úÖ 5 min deploy</span></td>
            </tr>
        </tbody>
    </table>

    <h1>üéØ Li√ß√µes Aprendidas</h1>

    <div class="solution-section">
        <h2>üîç Decision Tree: Fargate vs EC2</h2>
        
        <h3>Escolher Fargate quando:</h3>
        <ul>
            <li>‚úÖ Workloads stateless simples</li>
            <li>‚úÖ Conectividade b√°sica (internet)</li>
            <li>‚úÖ N√£o precisa de DNS customizado</li>
            <li>‚úÖ Sem requisitos de networking complexo</li>
        </ul>

        <h3>Escolher EC2 quando:</h3>
        <ul>
            <li>‚úÖ Conectividade privada (MSK, RDS)</li>
            <li>‚úÖ DNS resolution cr√≠tica</li>
            <li>‚úÖ Controle de networking necess√°rio</li>
            <li>‚úÖ Troubleshooting profundo requerido</li>
        </ul>
    </div>

    <h1>üîÆ Valida√ß√£o Final</h1>

    <div class="solution-section">
        <h2>Testes de Conectividade:</h2>
        <div class="code-block" data-lang="bash">
# DNS Test
‚úÖ nslookup google.com ‚Üí Working
‚úÖ nslookup b-1.dryrunbrqmsk.cxgo3g.c2.kafka.sa-east-1.amazonaws.com ‚Üí Working

# Health Checks
‚úÖ curl http://localhost:8080/actuator/health ‚Üí {"status":"UP"}
‚úÖ curl http://localhost:8081/actuator/health ‚Üí {"status":"UP"}

# Kubernetes Status
‚úÖ kubectl get pods -n etl ‚Üí All Running
‚úÖ kubectl get nodes ‚Üí 2/2 Ready
        </div>
    </div>

    <div class="highlight-box">
        <h2 style="margin: 0; border: none;">üèÜ Conclus√£o</h2>
        <p style="font-size: 14pt; margin: 15px 0;">
            A migra√ß√£o de <strong>Fargate para EC2</strong> foi cr√≠tica para o sucesso do projeto.<br>
            Para workloads enterprise com depend√™ncias de conectividade privada complexa,<br>
            <strong>EC2 managed nodes</strong> oferecem a confiabilidade necess√°ria.
        </p>
        <h1 style="margin: 20px 0; border: none; color: #27ae60;">
            ‚úÖ Sistema ETL 100% Operacional em Produ√ß√£o
        </h1>
    </div>

    <div class="footer">
        <p><strong>Document Information</strong></p>
        <p>Generated on: October 14, 2025</p>
        <p>Project: ETL System - BRQ Ita√∫ | Stack: Spring Boot 3.2.2 + Kotlin + AWS EKS + MSK</p>
        <p>Status: <span class="success">‚úÖ Production Operational</span></p>
        <p><em>Para gerar PDF: Imprimir esta p√°gina no navegador ‚Üí Salvar como PDF</em></p>
    </div>

    <script>
        // Auto-open print dialog for PDF generation
        document.addEventListener('DOMContentLoaded', function() {
            // Uncomment the line below to auto-open print dialog
            // window.print();
        });
    </script>
</body>
</html>
